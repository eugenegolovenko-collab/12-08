# Домашнее задание к занятию "`Резервное копирование баз данных`" - `Евгений Головенко`
### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение 1

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день (RPO = 24 часа) с проверкой восстановления. Про “потерю внутри дня” речи нет.
Приемлемый вариант резервного копирования - полное ежедневное резервное копирование (Full Backup).
Каждый день снимается полный бэкап всей БД. Хранятся, допустим, 30 последних копий.
Восстановление осуществляется поднятием необходимого бэкапа, в данном случае последнего.


1.2. Необходимо восстанавливать данные за час до предполагаемой поломки. 
Можно использовать полный бэкап раз в сутки и диффиренциальный бэкап каждый час, но лучше чаще, если говорим про финтех.
Для восстановления берется последний полный бэкап и последний дифференциальный бэкап.

Если критичен размер дискового пространства, то возможно использовать инкрементальный бэкап. В этом случае для восстановления берется последний полный бэкап и все инкременты с момента последнего полного бэкапа. Это займет больше времени, что может быть неприемлимым.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных?

Да, вполне. Схема может включать `master` и `standby slave` с синхронной репликацией (когда данные записываются в `master`, система ждёт, пока они точно попадут `slave`, перед тем как подтвердить операцию пользователю), лучше организовать несколько реплик под разные задачи, в том числе и под `standby`. Разумеется еще должно быть организовано дифференциальное резервное копирование с достаточной частотой. При падении `master` автоматический failover сразу переключает клиентов на `standby slave`, который становиться основным источником истины для системы (пока не поднимут упавшего). Такой подход должен обеспечить минимальный простой (RTO секунды), исключить потерю данных (RPO = 0). Все работает в реальном времени и не надо ждать бэкапов. Таким образом, доступность системы из проблемы превращается в расходы, но репутация дороже.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

### Решение 2.

Что будет сделано:
- создание БД `netology_12_08`;
- создание таблицы `users` и наполнение ее данными;
- создание бэкапа `netology_12_08_backup.dump`;
- создание резервной базы данных `netology_12_08_restore`, чтобы не перезаписывать существующую;
- восстановление данных из бэкапа.

```sql
CREATE DATABASE netology_12_08 --создание БД netology_12_08

--создание таблицы `users` и наполнение ее данными
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50)
);

INSERT INTO users (name) VALUES
('Neo'),
('White_rabbit'),
('Johny_Fuckifaster'),
('Trinity'),
('Multifinger');

select * from users;
```
```
id|name             |
--+-----------------+
 1|Neo              |
 2|White_rabbit     |
 3|Johny_Fuckifaster|
 4|Trinity          |
 5|Multifinger      |
```

Создание бэкапа:

```cmd
pg_dump -U postgres -F c -b -v -f "e:\DB\PostgreSQL\backup\netology_12_08_backup.dump" netology_12_08
```
- -U postgres — пользователь PostgreSQL;
- -F c — формат резервной копии: custom;
- -b — включить большие объекты (BLOB);
- -v — verbose (подробный вывод);
- -f "e:\DB\PostgreSQL\backup\netology_12_08_backup.dump" — имя файла резервной копии;
- netology_12_08 — имя резервируемой базы данных.

<img width="1119" height="900" alt="Capture1" src="https://github.com/user-attachments/assets/882668d7-5ab8-4ee5-b7de-0991074ea5e6" />

<img width="701" height="223" alt="Capture2" src="https://github.com/user-attachments/assets/425d7b2c-f239-4c15-88e1-7f442f7cd1c8" />

Создание резервной базы данных:

```
CREATE DATABASE netology_12_08_restore;
```

Восстановление базы данных из бэкапа:

```cmd
C:\Program Files\PostgreSQL\18\bin>pg_restore -U postgres -d netology_12_08_restore -v "e:\DB\PostgreSQL\backup\netology_12_08_backup.dump"
```
- -U postgres — пользователь;
- -d netology_12_08_restore — база, куда восстанавливаем;
- -v — подробный режим (verbose);
- "e:\DB\PostgreSQL\backup\netology_12_08_backup.dump" — файл резервной копии.

<img width="1117" height="219" alt="Capture3" src="https://github.com/user-attachments/assets/abb4f924-2228-4472-8159-5e7e8988d0d6" />

<img width="1025" height="886" alt="Capture4" src="https://github.com/user-attachments/assets/09e50c1e-3578-4a19-94ce-2f2555d4e604" />


2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---


